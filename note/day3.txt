ç¬¬ä¸‰å¤©ï¼šJWTè®¤è¯ä¸æˆ¿æºè¡¨è®¾è®¡ ğŸš€
æ­å–œè¿›å…¥ç¬¬ä¸‰å¤©ï¼ä»Šå¤©æˆ‘ä»¬è¦åšä¸¤ä»¶å¤§äº‹ï¼š

é›†æˆ JWT - è®©ç™»å½•è¿”å› token

è®¾è®¡æˆ¿æºè¡¨ - å¼€å§‹æ ¸å¿ƒä¸šåŠ¡

ä»Šæ—¥ä»»åŠ¡æ¸…å•
æ­¥éª¤	ä»»åŠ¡	è¯´æ˜
1	æ·»åŠ  JWT ä¾èµ–	pom.xml åŠ  jjwt
2	åˆ›å»º JWT å·¥å…·ç±»	ç”Ÿæˆå’ŒéªŒè¯ token
3	ä¿®æ”¹ç™»å½•æ¥å£	ç™»å½•æˆåŠŸè¿”å› token
4	åˆ›å»ºæ‹¦æˆªå™¨	éªŒè¯ token
5	è®¾è®¡æˆ¿æºè¡¨	åˆ›å»º house ç›¸å…³è¡¨
6	æµ‹è¯• JWT æµç¨‹	å¸¦ token è®¿é—®æ¥å£
ä¸€ã€æ·»åŠ  JWT ä¾èµ–
åœ¨ pom.xml ä¸­æ·»åŠ ï¼š

xml
<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
äºŒã€åˆ›å»º JWT å·¥å…·ç±»
åœ¨ utils åŒ…ä¸‹åˆ›å»º JwtUtil.javaï¼š

java
package com.example.houserentalsystem.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Component
public class JwtUtil {

    // å¯†é’¥ï¼ˆå®é™…ç”Ÿäº§ç¯å¢ƒåº”è¯¥æ”¾åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼‰
    private static final String SECRET = "MySecretKeyForJWTGeneration2024SpringBootHouseRentalSystem";
    private static final long EXPIRATION_TIME = 7 * 24 * 60 * 60 * 1000; // 7å¤©

    private Key getSigningKey() {
        return Keys.hmacShaKeyFor(SECRET.getBytes());
    }

    /**
     * ç”ŸæˆToken
     */
    public String generateToken(Long userId, String username, Long roleId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("username", username);
        claims.put("roleId", roleId);

        return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(getSigningKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    /**
     * éªŒè¯Tokenå¹¶è·å–Claims
     */
    public Claims parseToken(String token) {
        try {
            return Jwts.parserBuilder()
                    .setSigningKey(getSigningKey())
                    .build()
                    .parseClaimsJws(token)
                    .getBody();
        } catch (Exception e) {
            return null;
        }
    }

    /**
     * ä»Tokenè·å–ç”¨æˆ·ID
     */
    public Long getUserIdFromToken(String token) {
        Claims claims = parseToken(token);
        return claims != null ? claims.get("userId", Long.class) : null;
    }

    /**
     * ä»Tokenè·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        Claims claims = parseToken(token);
        return claims != null ? claims.get("username", String.class) : null;
    }

    /**
     * ä»Tokenè·å–è§’è‰²ID
     */
    public Long getRoleIdFromToken(String token) {
        Claims claims = parseToken(token);
        return claims != null ? claims.get("roleId", Long.class) : null;
    }

    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token) {
        return parseToken(token) != null;
    }
}
ä¸‰ã€åˆ›å»ºç™»å½•å“åº”DTO
åœ¨ dto åŒ…ä¸‹åˆ›å»º LoginResponseDTO.javaï¼š

java
package com.example.houserentalsystem.dto;

import com.example.houserentalsystem.entity.User;
import lombok.Data;

@Data
public class LoginResponseDTO {
    private String token;
    private User user;

    public LoginResponseDTO(String token, User user) {
        this.token = token;
        this.user = user;
        this.user.setPassword(null); // æ¸…é™¤æ•æ„Ÿä¿¡æ¯
    }
}
å››ã€ä¿®æ”¹ç™»å½•æ¥å£
ä¿®æ”¹ UserController.javaï¼š

java
package com.example.houserentalsystem.controller;

import com.example.houserentalsystem.common.Result;
import com.example.houserentalsystem.dto.LoginResponseDTO;
import com.example.houserentalsystem.dto.RegisterDTO;
import com.example.houserentalsystem.entity.User;
import com.example.houserentalsystem.service.UserService;
import com.example.houserentalsystem.utils.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/user")
public class UserController {

    @Autowired
    private UserService userService;
    
    @Autowired
    private JwtUtil jwtUtil;  // æ³¨å…¥ JWT å·¥å…·ç±»

    @PostMapping("/register")
    public Result<User> register(@RequestBody RegisterDTO registerDTO) {
        User user = userService.register(registerDTO);
        user.setPassword(null);
        return Result.success("æ³¨å†ŒæˆåŠŸ", user);
    }

    @PostMapping("/login")
    public Result<LoginResponseDTO> login(@RequestParam String username, 
                                          @RequestParam String password) {
        // 1. ç”¨æˆ·ç™»å½•éªŒè¯
        User user = userService.login(username, password);
        
        // 2. ç”Ÿæˆ JWT Token
        String token = jwtUtil.generateToken(user.getId(), user.getUsername(), user.getRoleId());
        
        // 3. è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
        LoginResponseDTO response = new LoginResponseDTO(token, user);
        return Result.success("ç™»å½•æˆåŠŸ", response);
    }

    @GetMapping("/info/{id}")
    public Result<User> getUserInfo(@PathVariable Long id) {
        User user = userService.getById(id);
        if (user == null) {
            return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        user.setPassword(null);
        return Result.success(user);
    }
}
äº”ã€åˆ›å»º JWT æ‹¦æˆªå™¨
5.1 åˆ›å»ºè‡ªå®šä¹‰æ³¨è§£
åœ¨ annotation åŒ…ä¸‹åˆ›å»º RequireToken.javaï¼š

java
package com.example.houserentalsystem.annotation;

import java.lang.annotation.*;

@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RequireToken {
    boolean required() default true;
}
5.2 åˆ›å»ºæ‹¦æˆªå™¨
åœ¨ interceptor åŒ…ä¸‹åˆ›å»º JwtInterceptor.javaï¼š

java
package com.example.houserentalsystem.interceptor;

import com.example.houserentalsystem.annotation.RequireToken;
import com.example.houserentalsystem.common.BusinessException;
import com.example.houserentalsystem.utils.JwtUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class JwtInterceptor implements HandlerInterceptor {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 1. å¦‚æœä¸æ˜¯æ–¹æ³•è¯·æ±‚ï¼Œç›´æ¥æ”¾è¡Œ
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }

        // 2. æ£€æŸ¥æ–¹æ³•ä¸Šæ˜¯å¦æœ‰ @RequireToken æ³¨è§£
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        RequireToken requireToken = handlerMethod.getMethodAnnotation(RequireToken.class);
        
        // 3. å¦‚æœæ²¡æœ‰æ³¨è§£ï¼Œæˆ–è€…æ³¨è§£çš„ required = falseï¼Œæ”¾è¡Œ
        if (requireToken == null || !requireToken.required()) {
            return true;
        }

        // 4. ä»è¯·æ±‚å¤´è·å– token
        String token = request.getHeader("Authorization");
        if (token == null || token.isEmpty()) {
            throw new BusinessException(401, "æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•");
        }

        // 5. å»æ‰ Bearer å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
        if (token.startsWith("Bearer ")) {
            token = token.substring(7);
        }

        // 6. éªŒè¯ token
        if (!jwtUtil.validateToken(token)) {
            throw new BusinessException(401, "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        }

        // 7. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ requestï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
        Long userId = jwtUtil.getUserIdFromToken(token);
        request.setAttribute("userId", userId);
        
        return true;
    }
}
5.3 é…ç½®æ‹¦æˆªå™¨
åœ¨ config åŒ…ä¸‹åˆ›å»º WebMvcConfig.javaï¼š

java
package com.example.houserentalsystem.config;

import com.example.houserentalsystem.interceptor.JwtInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Autowired
    private JwtInterceptor jwtInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor)
                .addPathPatterns("/**")  // æ‹¦æˆªæ‰€æœ‰è¯·æ±‚
                .excludePathPatterns(    // æ’é™¤ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„
                        "/api/user/login",
                        "/api/user/register",
                        "/api/test/**"
                );
    }
}
å…­ã€åˆ›å»ºæµ‹è¯•éœ€è¦ token çš„æ¥å£
åœ¨ UserController.java ä¸­æ·»åŠ ï¼š

java
/**
 * è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦tokenï¼‰
 */
@GetMapping("/current")
@RequireToken  // éœ€è¦tokenæ‰èƒ½è®¿é—®
public Result<User> getCurrentUser(HttpServletRequest request) {
    Long userId = (Long) request.getAttribute("userId");
    User user = userService.getById(userId);
    user.setPassword(null);
    return Result.success(user);
}
ä¸ƒã€æˆ¿æºè¡¨è®¾è®¡
åˆ›å»ºæˆ¿æºè¡¨ SQL
sql
-- æˆ¿æºè¡¨
CREATE TABLE `house` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æˆ¿æºID',
    `title` VARCHAR(100) NOT NULL COMMENT 'æˆ¿æºæ ‡é¢˜',
    `description` TEXT COMMENT 'æˆ¿æºæè¿°',
    `price` DECIMAL(10,2) NOT NULL COMMENT 'æœˆç§Ÿé‡‘ï¼ˆå…ƒï¼‰',
    `area` DECIMAL(8,2) COMMENT 'é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰',
    `bedroom_count` INT DEFAULT 1 COMMENT 'å§å®¤æ•°é‡',
    `living_room_count` INT DEFAULT 1 COMMENT 'å®¢å…æ•°é‡',
    `bathroom_count` INT DEFAULT 1 COMMENT 'å«ç”Ÿé—´æ•°é‡',
    `floor` VARCHAR(20) COMMENT 'æ‰€åœ¨æ¥¼å±‚',
    `property_type` VARCHAR(20) COMMENT 'æˆ¿äº§ç±»å‹',
    `decoration` VARCHAR(20) COMMENT 'è£…ä¿®æƒ…å†µ',
    `orientation` VARCHAR(10) COMMENT 'æœå‘',
    `province` VARCHAR(50) COMMENT 'çœä»½',
    `city` VARCHAR(50) COMMENT 'åŸå¸‚',
    `district` VARCHAR(50) COMMENT 'åŒºåŸŸ',
    `address` VARCHAR(200) NOT NULL COMMENT 'è¯¦ç»†åœ°å€',
    `landlord_id` BIGINT NOT NULL COMMENT 'æˆ¿ä¸œID',
    `status` TINYINT DEFAULT 0 COMMENT 'çŠ¶æ€ï¼š0-å¾…å®¡æ ¸ï¼Œ1-å·²ä¸Šæ¶ï¼Œ2-å·²ä¸‹æ¶ï¼Œ3-å·²å‡ºç§Ÿ',
    `view_count` INT DEFAULT 0 COMMENT 'æµè§ˆæ¬¡æ•°',
    `favorite_count` INT DEFAULT 0 COMMENT 'æ”¶è—æ¬¡æ•°',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å‘å¸ƒæ—¶é—´',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX `idx_landlord_id` (`landlord_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_city_district` (`city`, `district`),
    INDEX `idx_price` (`price`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æˆ¿æºè¡¨';

-- æˆ¿æºå›¾ç‰‡è¡¨
CREATE TABLE `house_image` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `house_id` BIGINT NOT NULL COMMENT 'æˆ¿æºID',
    `image_url` VARCHAR(500) NOT NULL COMMENT 'å›¾ç‰‡URL',
    `sort` INT DEFAULT 0 COMMENT 'æ’åº',
    `type` TINYINT DEFAULT 1 COMMENT 'ç±»å‹ï¼š1-å°é¢å›¾ï¼Œ2-æ™®é€šå›¾',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
    KEY `idx_house_id` (`house_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æˆ¿æºå›¾ç‰‡è¡¨';
å…«ã€æµ‹è¯• JWT
åˆ›å»º test_jwt.httpï¼š

http
### åŸºç¡€å˜é‡
@baseUrl = http://localhost:8080

### 1. ç™»å½•è·å–token
# @name login
POST {{baseUrl}}/api/user/login?username=admin&password=123456

### 2. ä¿å­˜tokenåˆ°å˜é‡
@authToken = {{login.response.body.data.token}}

### 3. æµ‹è¯•éœ€è¦tokençš„æ¥å£
GET {{baseUrl}}/api/user/current
Authorization: Bearer {{authToken}}

### 4. æµ‹è¯•ä¸å¸¦tokenï¼ˆåº”è¯¥è¿”å›401ï¼‰
GET {{baseUrl}}/api/user/current

### 5. æµ‹è¯•å¸¦é”™è¯¯token
GET {{baseUrl}}/api/user/current
Authorization: Bearer xxx.yyy.zzz
ä»Šæ—¥ä»»åŠ¡æ¸…å•
æ·»åŠ  JWT ä¾èµ–

åˆ›å»º JwtUtil

åˆ›å»º LoginResponseDTO

ä¿®æ”¹ç™»å½•æ¥å£è¿”å› token

åˆ›å»º JwtInterceptor

é…ç½® WebMvcConfig

æ·»åŠ  @RequireToken æ³¨è§£

åˆ›å»ºéœ€è¦ token çš„æµ‹è¯•æ¥å£

æ‰§è¡Œæˆ¿æºè¡¨ SQL

ç”¨ REST Client æµ‹è¯• JWT æµç¨‹