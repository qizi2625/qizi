ç¬¬äºŒå¤©ï¼šæ•°æ®åº“è®¾è®¡ä¸ç”¨æˆ·æ¨¡å—åŸºç¡€
ğŸ“‹ ä»Šæ—¥ä»»åŠ¡æ¸…å•
è®¾è®¡RBACæƒé™æ¨¡å‹çš„æ•°æ®åº“è¡¨

åˆ›å»ºå®ä½“ç±»

å®ç°ç”¨æˆ·æ³¨å†Œæ¥å£

å®ç°ç”¨æˆ·ç™»å½•æ¥å£ï¼ˆç®€å•ç‰ˆï¼Œæš‚ä¸åŠ JWTï¼‰

ä¸€ã€RBACæ•°æ®åº“è¡¨è®¾è®¡
æ ¹æ®ä½ çš„æ¯•è®¾éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸‹æ ¸å¿ƒè¡¨ï¼š

1. ç”¨æˆ·è¡¨ (user)
sql
CREATE TABLE `user` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    `username` varchar(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    `password` varchar(100) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
    `phone` varchar(20) COMMENT 'æ‰‹æœºå·',
    `email` varchar(100) COMMENT 'é‚®ç®±',
    `avatar` varchar(500) COMMENT 'å¤´åƒURL',
    `real_name` varchar(50) COMMENT 'çœŸå®å§“å',
    `id_card` varchar(18) COMMENT 'èº«ä»½è¯å·',
    `role_id` bigint COMMENT 'è§’è‰²ID',
    `status` tinyint DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-ç¦ç”¨ï¼Œ1-æ­£å¸¸',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
2. è§’è‰²è¡¨ (role)
sql
CREATE TABLE `role` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT COMMENT 'è§’è‰²ID',
    `role_name` varchar(50) NOT NULL COMMENT 'è§’è‰²åç§°',
    `role_code` varchar(50) NOT NULL COMMENT 'è§’è‰²ç¼–ç ï¼ˆå¦‚ï¼šADMIN, LANDLORD, TENANTï¼‰',
    `description` varchar(200) COMMENT 'è§’è‰²æè¿°',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²è¡¨';
3. æƒé™è¡¨ (permission)
sql
CREATE TABLE `permission` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT COMMENT 'æƒé™ID',
    `permission_name` varchar(50) NOT NULL COMMENT 'æƒé™åç§°',
    `permission_code` varchar(100) NOT NULL COMMENT 'æƒé™ç¼–ç ï¼ˆå¦‚ï¼šhouse:add, order:viewï¼‰',
    `type` tinyint COMMENT 'ç±»å‹ï¼š1-èœå•ï¼Œ2-æŒ‰é’®',
    `parent_id` bigint DEFAULT 0 COMMENT 'çˆ¶æƒé™ID',
    `path` varchar(200) COMMENT 'è·¯ç”±è·¯å¾„',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æƒé™è¡¨';
4. è§’è‰²-æƒé™å…³è”è¡¨ (role_permission)
sql
CREATE TABLE `role_permission` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT,
    `role_id` bigint NOT NULL COMMENT 'è§’è‰²ID',
    `permission_id` bigint NOT NULL COMMENT 'æƒé™ID',
    KEY `idx_role_id` (`role_id`),
    KEY `idx_permission_id` (`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²æƒé™å…³è”è¡¨';
äºŒã€æ’å…¥åˆå§‹æ•°æ®
æ‰§è¡Œä»¥ä¸‹SQLæ’å…¥åŸºç¡€è§’è‰²å’Œæµ‹è¯•ç”¨æˆ·ï¼š

sql
-- æ’å…¥è§’è‰²
INSERT INTO `role` (`role_name`, `role_code`) VALUES 
('ç®¡ç†å‘˜', 'ADMIN'),
('æˆ¿ä¸œ', 'LANDLORD'),
('ç§Ÿå®¢', 'TENANT');

-- æ’å…¥æµ‹è¯•ç”¨æˆ·ï¼ˆå¯†ç ï¼š123456ï¼Œè¦ç”¨BCryptåŠ å¯†ï¼Œæˆ‘ä»¬å…ˆç”¨æ˜æ–‡ï¼Œåç»­å†åŠ ï¼‰
INSERT INTO `user` (`username`, `password`, `phone`, `role_id`) VALUES 
('admin', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', '13800000001', 1),  -- å¯†ç :123456
('landlord1', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', '13800000002', 2),
('tenant1', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', '13800000003', 3);
âš ï¸ æ³¨æ„ï¼šä¸Šé¢çš„åŠ å¯†å¯†ç æ˜¯ 123456 çš„BCryptå“ˆå¸Œå€¼ã€‚æˆ‘ä»¬é©¬ä¸Šä¼šåœ¨ä»£ç é‡Œå®ç°å¯†ç åŠ å¯†ã€‚

ä¸‰ã€åˆ›å»ºå®ä½“ç±»
åœ¨ entity åŒ…ä¸‹åˆ›å»ºå¯¹åº”çš„å®ä½“ç±»ï¼š

User.java
java
package com.example.houserentalsystem.entity;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class User {
    private Long id;
    private String username;
    private String password;
    private String phone;
    private String email;
    private String avatar;
    private String realName;
    private String idCard;
    private Long roleId;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
Role.java
java
package com.example.houserentalsystem.entity;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class Role {
    private Long id;
    private String roleName;
    private String roleCode;
    private String description;
    private LocalDateTime createTime;
}
å››ã€æ·»åŠ å¯†ç åŠ å¯†ä¾èµ–
åœ¨ pom.xml ä¸­æ·»åŠ Spring Securityä¾èµ–ï¼ˆä»…ç”¨äºå¯†ç åŠ å¯†ï¼Œä¸ç”¨å®ƒçš„æƒé™æ¡†æ¶ï¼‰ï¼š

xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
æ·»åŠ åè®°å¾—åˆ·æ–°Mavenã€‚

äº”ã€é…ç½®å¯†ç åŠ å¯†å·¥å…·ç±»
åœ¨ utils åŒ…ä¸‹åˆ›å»º PasswordEncoderUtil.javaï¼š

java
package com.example.houserentalsystem.utils;

import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Component;

@Component
public class PasswordEncoderUtil {
    
    private final BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
    
    /**
     * åŠ å¯†å¯†ç 
     */
    public String encode(String rawPassword) {
        return encoder.encode(rawPassword);
    }
    
    /**
     * åŒ¹é…å¯†ç 
     */
    public boolean matches(String rawPassword, String encodedPassword) {
        return encoder.matches(rawPassword, encodedPassword);
    }
}
å…­ã€åˆ›å»ºç”¨æˆ·æ¨¡å—çš„Mapperå’ŒService
1. åˆ›å»ºUserMapperæ¥å£
åœ¨ mapper åŒ…ä¸‹åˆ›å»º UserMapper.javaï¼š

java
package com.example.houserentalsystem.mapper;

import com.example.houserentalsystem.entity.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface UserMapper {
    
    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
     */
    User findByUsername(@Param("username") String username);
    
    /**
     * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
     */
    User findByPhone(@Param("phone") String phone);
    
    /**
     * æ’å…¥æ–°ç”¨æˆ·
     */
    int insert(User user);
    
    /**
     * æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
     */
    User findById(@Param("id") Long id);
}
2. åˆ›å»ºMapper XMLæ–‡ä»¶
åœ¨ resources/mapper ç›®å½•ä¸‹åˆ›å»º UserMapper.xmlï¼š

xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.houserentalsystem.mapper.UserMapper">
    
    <resultMap id="BaseResultMap" type="com.example.houserentalsystem.entity.User">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="phone" property="phone"/>
        <result column="email" property="email"/>
        <result column="avatar" property="avatar"/>
        <result column="real_name" property="realName"/>
        <result column="id_card" property="idCard"/>
        <result column="role_id" property="roleId"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    
    <sql id="Base_Column_List">
        id, username, password, phone, email, avatar, real_name, id_card, 
        role_id, status, create_time, update_time
    </sql>
    
    <select id="findByUsername" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user
        WHERE username = #{username}
    </select>
    
    <select id="findByPhone" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user
        WHERE phone = #{phone}
    </select>
    
    <select id="findById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM user
        WHERE id = #{id}
    </select>
    
    <insert id="insert" parameterType="com.example.houserentalsystem.entity.User" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (
            username, password, phone, email, avatar, 
            real_name, id_card, role_id, status
        ) VALUES (
            #{username}, #{password}, #{phone}, #{email}, #{avatar},
            #{realName}, #{idCard}, #{roleId}, #{status}
        )
    </insert>
    
</mapper>
3. åˆ›å»ºUserServiceæ¥å£
åœ¨ service åŒ…ä¸‹åˆ›å»º UserService.javaï¼š

java
package com.example.houserentalsystem.service;

import com.example.houserentalsystem.entity.User;
import com.example.houserentalsystem.dto.RegisterDTO;

public interface UserService {
    
    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    User register(RegisterDTO registerDTO);
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    User login(String username, String password);
    
    /**
     * æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
     */
    User getById(Long id);
}
4. åˆ›å»ºDTOç±»
åœ¨ dto åŒ…ä¸‹åˆ›å»º RegisterDTO.javaï¼š

java
package com.example.houserentalsystem.dto;

import lombok.Data;

@Data
public class RegisterDTO {
    private String username;
    private String password;
    private String phone;
    private String email;
    private String realName;
    private String idCard;
    private Long roleId;  // é»˜è®¤ç§Ÿå®¢ä¸º3ï¼Œæˆ¿ä¸œä¸º2
}
5. å®ç°UserService
åœ¨ service/impl åŒ…ä¸‹åˆ›å»º UserServiceImpl.javaï¼š

java
package com.example.houserentalsystem.service.impl;

import com.example.houserentalsystem.entity.User;
import com.example.houserentalsystem.mapper.UserMapper;
import com.example.houserentalsystem.service.UserService;
import com.example.houserentalsystem.dto.RegisterDTO;
import com.example.houserentalsystem.utils.PasswordEncoderUtil;
import com.example.houserentalsystem.common.BusinessException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private PasswordEncoderUtil passwordEncoder;
    
    @Override
    public User register(RegisterDTO registerDTO) {
        // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        User existingUser = userMapper.findByUsername(registerDTO.getUsername());
        if (existingUser != null) {
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // 2. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
        existingUser = userMapper.findByPhone(registerDTO.getPhone());
        if (existingUser != null) {
            throw new BusinessException("æ‰‹æœºå·å·²æ³¨å†Œ");
        }
        
        // 3. åˆ›å»ºæ–°ç”¨æˆ·
        User user = new User();
        user.setUsername(registerDTO.getUsername());
        user.setPassword(passwordEncoder.encode(registerDTO.getPassword()));
        user.setPhone(registerDTO.getPhone());
        user.setEmail(registerDTO.getEmail());
        user.setRealName(registerDTO.getRealName());
        user.setIdCard(registerDTO.getIdCard());
        user.setRoleId(registerDTO.getRoleId() != null ? registerDTO.getRoleId() : 3L); // é»˜è®¤ç§Ÿå®¢
        user.setStatus(1); // é»˜è®¤æ­£å¸¸
        
        // 4. ä¿å­˜åˆ°æ•°æ®åº“
        userMapper.insert(user);
        
        return user;
    }
    
    @Override
    public User login(String username, String password) {
        // 1. æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.findByUsername(username);
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new BusinessException("å¯†ç é”™è¯¯");
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        if (user.getStatus() != 1) {
            throw new BusinessException("è´¦å·å·²è¢«ç¦ç”¨");
        }
        
        return user;
    }
    
    @Override
    public User getById(Long id) {
        return userMapper.findById(id);
    }
}
6. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸ç±»
åœ¨ common åŒ…ä¸‹åˆ›å»º BusinessException.javaï¼š

java
package com.example.houserentalsystem.common;

public class BusinessException extends RuntimeException {
    private Integer code;
    
    public BusinessException(String message) {
        super(message);
        this.code = 500;
    }
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
    
    public Integer getCode() {
        return code;
    }
}
ä¸ƒã€åˆ›å»ºç”¨æˆ·æ§åˆ¶å™¨
åœ¨ controller åŒ…ä¸‹åˆ›å»º UserController.javaï¼š

java
package com.example.houserentalsystem.controller;

import com.example.houserentalsystem.common.Result;
import com.example.houserentalsystem.dto.RegisterDTO;
import com.example.houserentalsystem.entity.User;
import com.example.houserentalsystem.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/user")
public class UserController {

    @Autowired
    private UserService userService;

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public Result<User> register(@RequestBody RegisterDTO registerDTO) {
        User user = userService.register(registerDTO);
        // è¿”å›å‰æ¸…é™¤æ•æ„Ÿä¿¡æ¯
        user.setPassword(null);
        return Result.success("æ³¨å†ŒæˆåŠŸ", user);
    }

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public Result<User> login(@RequestParam String username, 
                              @RequestParam String password) {
        User user = userService.login(username, password);
        // è¿”å›å‰æ¸…é™¤æ•æ„Ÿä¿¡æ¯
        user.setPassword(null);
        return Result.success("ç™»å½•æˆåŠŸ", user);
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/info/{id}")
    public Result<User> getUserInfo(@PathVariable Long id) {
        User user = userService.getById(id);
        if (user == null) {
            return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        user.setPassword(null);
        return Result.success(user);
    }
}
å…«ã€æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†
åœ¨ common åŒ…ä¸‹åˆ›å»º GlobalExceptionHandler.javaï¼š

java
package com.example.houserentalsystem.common;

import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BusinessException.class)
    public Result<String> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public Result<String> handleException(Exception e) {
        e.printStackTrace();  // æ‰“å°å †æ ˆä¿¡æ¯æ–¹ä¾¿è°ƒè¯•
        return Result.error("ç³»ç»Ÿå¼‚å¸¸ï¼š" + e.getMessage());
    }
}
ä¹ã€æµ‹è¯•æ¥å£
ç°åœ¨å¯ä»¥å¯åŠ¨é¡¹ç›®æµ‹è¯•äº†ï¼š

1. æµ‹è¯•æ³¨å†Œæ¥å£
ä½¿ç”¨Postmanæˆ–Apifoxå‘é€POSTè¯·æ±‚ï¼š

text
URL: http://localhost:8080/api/user/register
Headers: Content-Type: application/json
Body:
{
    "username": "testuser",
    "password": "123456",
    "phone": "13888888888",
    "email": "test@example.com",
    "realName": "æµ‹è¯•ç”¨æˆ·",
    "roleId": 3
}
é¢„æœŸè¿”å›ï¼š

json
{
    "code": 200,
    "message": "æ³¨å†ŒæˆåŠŸ",
    "data": {
        "id": 4,
        "username": "testuser",
        "phone": "13888888888",
        "email": "test@example.com",
        "roleId": 3,
        "status": 1,
        ...
    }
}
2. æµ‹è¯•ç™»å½•æ¥å£
text
URL: http://localhost:8080/api/user/login?username=testuser&password=123456
Method: POST
é¢„æœŸè¿”å›ï¼š

json
{
    "code": 200,
    "message": "ç™»å½•æˆåŠŸ",
    "data": {
        "id": 4,
        "username": "testuser",
        "roleId": 3,
        ...
    }
}