<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.houserentalsystem.mapper.HouseMapper">
    
    <resultMap id="BaseResultMap" type="com.example.houserentalsystem.entity.House">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="price" property="price"/>
        <result column="area" property="area"/>
        <result column="bedroom_count" property="bedroomCount"/>
        <result column="living_room_count" property="livingRoomCount"/>
        <result column="bathroom_count" property="bathroomCount"/>
        <result column="floor" property="floor"/>
        <result column="property_type" property="propertyType"/>
        <result column="decoration" property="decoration"/>
        <result column="orientation" property="orientation"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="district" property="district"/>
        <result column="address" property="address"/>
        <result column="landlord_id" property="landlordId"/>
        <result column="status" property="status"/>
        <result column="view_count" property="viewCount"/>
        <result column="favorite_count" property="favoriteCount"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    
    <sql id="Base_Column_List">
        id, title, description, price, area, bedroom_count, living_room_count,
        bathroom_count, floor, property_type, decoration, orientation,
        province, city, district, address, landlord_id, status,
        view_count, favorite_count, create_time, update_time
    </sql>
    
    <insert id="insert" parameterType="com.example.houserentalsystem.entity.House" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO house (
            title, description, price, area, bedroom_count, living_room_count,
            bathroom_count, floor, property_type, decoration, orientation,
            province, city, district, address, landlord_id, status
        ) VALUES (
            #{title}, #{description}, #{price}, #{area}, #{bedroomCount}, #{livingRoomCount},
            #{bathroomCount}, #{floor}, #{propertyType}, #{decoration}, #{orientation},
            #{province}, #{city}, #{district}, #{address}, #{landlordId}, #{status}
        )
    </insert>
    
    <select id="findById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM house
        WHERE id = #{id}
    </select>
    
    <select id="findByLandlordId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM house
        WHERE landlord_id = #{landlordId}
        ORDER BY create_time DESC
    </select>
    
    <select id="pageQuery" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM house
        <where>
            <if test="query.keyword != null and query.keyword != ''">
                AND (title LIKE CONCAT('%', #{query.keyword}, '%')
                OR description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
            <if test="query.city != null and query.city != ''">
                AND city = #{query.city}
            </if>
            <if test="query.district != null and query.district != ''">
                AND district = #{query.district}
            </if>
            <if test="query.minPrice != null">
                AND price >= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>
            <if test="query.bedroomCount != null">
                AND bedroom_count = #{query.bedroomCount}
            </if>
            <if test="query.orientation != null and query.orientation != ''">
                AND orientation = #{query.orientation}
            </if>
            <if test="query.decoration != null and query.decoration != ''">
                AND decoration = #{query.decoration}
            </if>
            AND status = 1
        </where>
        ORDER BY 
        <choose>
            <when test="query.sortBy == 'price'">
                price ${query.sortOrder}
            </when>
            <when test="query.sortBy == 'create_time'">
                create_time ${query.sortOrder}
            </when>
            <otherwise>
                create_time DESC
            </otherwise>
        </choose>
        LIMIT #{query.size} OFFSET #{query.offset}  <!-- 这里用 query.offset -->
    </select>
    
    <select id="countQuery" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM house
        <where>
            <if test="query.keyword != null and query.keyword != ''">
                AND (title LIKE CONCAT('%', #{query.keyword}, '%')
                OR description LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
            <if test="query.city != null and query.city != ''">
                AND city = #{query.city}
            </if>
            <if test="query.district != null and query.district != ''">
                AND district = #{query.district}
            </if>
            <if test="query.minPrice != null">
                AND price >= #{query.minPrice}
            </if>
            <if test="query.maxPrice != null">
                AND price &lt;= #{query.maxPrice}
            </if>
            <if test="query.bedroomCount != null">
                AND bedroom_count = #{query.bedroomCount}
            </if>
            AND status = 1
        </where>
    </select>
    
    <update id="update">
        UPDATE house
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="price != null">price = #{price},</if>
            <if test="area != null">area = #{area},</if>
            <if test="status != null">status = #{status},</if>
        </set>
        WHERE id = #{id}
    </update>
    
    <update id="updateStatus">
        UPDATE house SET status = #{status} WHERE id = #{id}
    </update>
    
    <update id="incrementViewCount">
        UPDATE house SET view_count = view_count + 1 WHERE id = #{id}
    </update>
    
    <update id="incrementFavoriteCount">
        UPDATE house SET favorite_count = favorite_count + 1 WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM house WHERE id = #{id}
    </delete>
</mapper>